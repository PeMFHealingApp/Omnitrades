<!DOCTYPE html>
     <html lang="en">
     <head>
       <meta charset="UTF-8">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <title>OmniTrades Dashboard</title>
       <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
       <style>
         body {
           font-family: Arial, sans-serif;
           margin: 20px;
           background-color: #1a1a1a;
           color: #e0e0e0;
         }
         .container { max-width: 800px; margin: auto; }
         .card { border: 1px solid #333; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #2c2c2c; }
         .info { font-size: 0.9em; color: #bbb; }
         .table-container { max-height: 200px; overflow-y: auto; }
         table { width: 100%; border-collapse: collapse; }
         th, td { border: 1px solid #444; padding: 8px; text-align: left; }
         th { background-color: #3a3a3a; }
         h1, h2 { color: #fff; }
         canvas { background-color: #2c2c2c; }
         .status-error { color: #ff4444; }
         .status-active { color: #00cc00; }
         .status-idle { color: #cccc00; }
       </style>
     </head>
     <body>
       <div class="container">
         <h1>OmniTrades Dashboard</h1>
         <div class="card">
           <h2>Current Stats</h2>
           <p id="currentCrypto">Trading: BTC</p>
           <p id="currentPrice">Current Price: Loading...</p>
           <p id="dataSource">Data Source: CoinGecko (Real-time, updated ${new Date().toLocaleTimeString()})</p>
           <p id="lastTrade">Last Trade: None</p>
           <p id="sentiment">Sentiment Score: Loading...</p>
           <p id="workflowStatus">Workflow Status: Loading...</p>
         </div>
         <div class="card">
           <h2>Performance Metrics</h2>
           <p id="totalPnl">Total P&L: $0.00</p>
           <p id="dailyEarnings">Daily Earnings: $0.00</p>
           <p id="winRate">Win Rate: 0%</p>
           <p id="numTrades">Number of Trades: 0</p>
           <p id="historicalRange">Historical Data: Jan 1, 2022 - ${new Date().toLocaleDateString()}</p>
         </div>
         <div class="card">
           <h2>Daily Gain/Loss</h2>
           <div class="table-container">
             <table id="gainLossTable">
               <thead>
                 <tr><th>Date</th><th>Gain/Loss ($)</th></tr>
               </thead>
               <tbody></tbody>
             </table>
             <p id="gainLossNote" class="info">Note: 404 indicates no trade/metrics data. Run the workflow or check <a href="https://github.com/PeMFHealingApp/Omnitrades/actions" target="_blank">logs</a> for issues (e.g., no trades, API errors).</p>
           </div>
         </div>
         <div class="card">
           <h2>Earnings Chart</h2>
           <canvas id="earningsChart"></canvas>
         </div>
         <div class="card">
           <h2>User Notes</h2>
           <p class="info">Status: Paper Trading on Binance Testnet ($100K virtual capital)</p>
           <p class="info">Goal: $1,000/day for 30 days (Aug 21 - Sep 21, 2025)</p>
           <p class="info">Auto-Correction: Adjusts thresholds if daily earnings < $1,000</p>
           <p class="info">Warning: Simulation includes 0.1% fees; no live trading yet. Contact support for issues.</p>
         </div>
       </div>

       <script>
         async function fetchData() {
           try {
             const tradeResponse = await fetch('https://raw.githubusercontent.com/PeMFHealingApp/Omnitrades/main/trades.csv');
             if (!tradeResponse.ok) throw new Error(`Trade data fetch failed: ${tradeResponse.status} ${tradeResponse.statusText}`);
             const tradeText = await tradeResponse.text();
             const tradeLines = tradeText.split('\n').filter(line => line.trim());
             const data = tradeLines.map(line => {
               const [time, price, predicted, sentiment, action, quantity] = line.split(',');
               return { time, price: parseFloat(price) || 0, predicted: parseFloat(predicted) || 0, sentiment: parseFloat(sentiment) || 0, action, quantity: parseFloat(quantity) || 0 };
             });

             let metricsResponse = await fetch('https://raw.githubusercontent.com/PeMFHealingApp/Omnitrades/main/daily_metrics.csv');
             if (!metricsResponse.ok) throw new Error(`Metrics data fetch failed: ${metricsResponse.status} ${metricsResponse.statusText}`);
             let metricsText = await metricsResponse.text();
             if (metricsResponse.status === 404) {
               document.getElementById('gainLossNote').textContent = 'Note: 404 indicates no trade/metrics data. Run the workflow or check <a href="https://github.com/PeMFHealingApp/Omnitrades/actions" target="_blank">logs</a> for issues (e.g., no trades, API errors).';
               metricsText = 'date,daily_earnings,total_pnl,win_rate,num_trades,avg_trade_profit,sharpe_ratio,max_drawdown,portfolio_value\n';
             }
             const metricsLines = metricsText.split('\n').filter(line => line.trim());
             const metrics = metricsLines.map(line => {
               const [date, daily_earnings, total_pnl, win_rate, num_trades, avg_trade_profit, sharpe_ratio, max_drawdown, portfolio_value] = line.split(',');
               return { date, daily_earnings: parseFloat(daily_earnings) || 0, total_pnl: parseFloat(total_pnl) || 0, win_rate: parseFloat(win_rate) || 0, num_trades: parseInt(num_trades) || 0, avg_trade_profit: parseFloat(avg_trade_profit) || 0, sharpe_ratio: parseFloat(sharpe_ratio) || 0, max_drawdown: parseFloat(max_drawdown) || 0, portfolio_value: parseFloat(portfolio_value) || 0 };
             });

             // Workflow status
             const workflowResponse = await fetch('https://api.github.com/repos/PeMFHealingApp/Omnitrades/actions/runs?per_page=1&status=completed', {
               headers: { 'Accept': 'application/vnd.github.v3+json' }
             });
             const workflowData = await workflowResponse.json();
             const latestRun = workflowData.workflow_runs[0];
             let statusText = 'IDLE: No Recent Run';
             let statusClass = 'status-idle';
             if (latestRun) {
               if (latestRun.conclusion === 'success') {
                 statusText = 'ACTIVE: Paper Trading';
                 statusClass = 'status-active';
               } else {
                 statusText = `ERROR: ${latestRun.message || 'Unknown error'}`;
                 statusClass = 'status-error';
               }
             }
             document.getElementById('workflowStatus').innerHTML = `<span class="${statusClass}">${statusText}</span>`;

             const lastTrade = data.length ? data[data.length - 1] : { action: 'None', price: 0, sentiment: 0 };
             const currentPrice = await get_current_price();
             document.getElementById('currentCrypto').textContent = `Trading: BTC`;
             document.getElementById('currentPrice').textContent = `Current Price: $${currentPrice.toFixed(2)}`;
             document.getElementById('dataSource').textContent = `Data Source: CoinGecko (Real-time, updated ${new Date().toLocaleTimeString()})`;
             document.getElementById('lastTrade').textContent = `Last Trade: ${lastTrade.action} ${lastTrade.quantity} at $${lastTrade.price.toFixed(2)}`;
             document.getElementById('sentiment').textContent = `Sentiment Score: ${lastTrade.sentiment.toFixed(2)}`;
             const latestMetrics = metrics.length ? metrics[metrics.length - 1] : {};
             document.getElementById('totalPnl').textContent = `Total P&L: $${latestMetrics.total_pnl.toFixed(2)}`;
             document.getElementById('dailyEarnings').textContent = `Daily Earnings: $${latestMetrics.daily_earnings.toFixed(2)}`;
             document.getElementById('winRate').textContent = `Win Rate: ${(latestMetrics.win_rate * 100).toFixed(2)}%`;
             document.getElementById('numTrades').textContent = `Number of Trades: ${latestMetrics.num_trades}`;
             document.getElementById('historicalRange').textContent = `Historical Data: Jan 1, 2022 - ${new Date().toLocaleDateString()}`;

             // Daily Gain/Loss Table
             const tableBody = document.querySelector('#gainLossTable tbody');
             tableBody.innerHTML = '';
             if (metricsResponse.status === 404 || !metrics.length) {
               const row = document.createElement('tr');
               row.innerHTML = `<td>Initial</td><td>$0.00</td>`;
               tableBody.appendChild(row);
             } else {
               metrics.forEach(metric => {
                 const row = document.createElement('tr');
                 row.innerHTML = `<td>${metric.date}</td><td>$${metric.daily_earnings.toFixed(2)}</td>`;
                 tableBody.appendChild(row);
               });
             }

             const ctx = document.getElementById('earningsChart').getContext('2d');
             new Chart(ctx, {
               type: 'line',
               data: {
                 labels: metrics.map(m => m.date),
                 datasets: [{
                   label: 'Daily Earnings ($)',
                   data: metrics.map(m => m.daily_earnings),
                   borderColor: 'rgba(75, 192, 192, 1)',
                   fill: false
                 }]
               },
               options: {
                 scales: { y: { beginAtZero: true } }
               }
             });
           } catch (error) {
             console.error('Error fetching data:', error);
             document.getElementById('workflowStatus').innerHTML = `<span class="status-error">ERROR: Failed to load data (${error.message})</span>`;
           }
         }

         async function get_current_price() {
           try {
             const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
             const data = await response.json();
             return data.bitcoin.usd || 0.0;
           } catch {
             return 0.0;
           }
         }

         fetchData();
         setInterval(fetchData, 60000); // Refresh every minute
       </script>
     </body>
     </html>
